<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <meta http-equiv="pragma" content="no-cache">
    <title>VP贷-享全款的汽车分期</title>
    <link href="/public/wap/images/logo-ico.png" type="image/x-icon" rel="shortcut icon">
    <link rel="stylesheet" href="/public/wap/css/framework7.ios.css">
    <link rel="stylesheet" href="/public/wap/css/framework7.ios.colors.min.css">
    <link rel="stylesheet" type="text/css" href="/public/wap/css/my-app.css" media="all">
	<style>
    .navbar .right {
        width: 60px;
        font-size: 16px;
    }
    .navbar .right img {
        width: 8px;
    }
    .subnavbar {
        background: #ffffff;
    }
    .subnavbar-box {
        width: 100%;
        height: 30px;
        overflow: hidden;
    }
    .subnavbar-wrap {
        width: 100%;
        height: 40px;
        position: relative;
        overflow: auto;
        overflow-y: hidden;
    }
    .subnavbar-cont {
        width: 480px;
        height: 40px;
    }
    .subnavbar-item {
        width: 74px;
        display: inline-block;
        font-size: 14px;
        text-align: center;
        color: #666666;
    }
	.subnavbar:after {
		display: none;
	}
	.tab_active {
		font-size: 16px;
		color:#ff9900;
		padding-bottom: 5px;
		border-bottom: 2px solid #ff9900;
	}
	#orderTabs {
		padding-top: 40px;
	}
	.order-list {
		height: 120px;
		border: 1px solid #DDDDDD;
		border-radius: 5px;
		margin: 15px 15px 0;
		padding: 0 15px;
		background-color: #ffffff;
		color: #333333;
	}
	.order-type {
		font-size: 14px;
	}
	.order-sn {
		letter-spacing: 0;
	}
	.order-sn,
	.order-type,
	.order-customer,
	.order-status {
		display: inline-block;
	}
	.order-status {
		width:54px;
	}
	.order-status img{
		width:100%;
	}
	.order-list-info {
		height: 40px;
		line-height: 40px;
		border-bottom: 1px solid #DDDDDD;
		font-size: 16px;
	}
	.order-customer {
		height: 80px;
	}
	.order-customer-name {
		margin-top: 10px;
		font-size: 24px;
		height: 32px;
	}
	.order-customer-mobile {
		font-size: 16px;
		color: #999999;
		height: 22px;
	}
	.order-status {
		margin-top: 10px;
	}
	.infinite-scroll-preloader {
		text-align: center;
	}
    .popover-dateRange {
        width: 200px;
    }
    .popover-dateRange .list-button {
        display: block;
        color: #000000;
        line-height: 30px;
        text-align: center;
        font-size: 16px;
        margin: 6px;
    }
	</style>
</head>
<body>
    <div class="views">
        <div class="view view-main">
	        <div class="navbar">
	            <div class="navbar-inner">
	                <div class="left">
	                    <a href="javascript:goToUrl(wechatStaticPath + '/index/index.html');" class="link icon-only back">
	                        <i class="icon icon-back color-orange"></i>
	                    </a>
	                </div>
	             	<div class="center">订单管理</div>
	             	<!-- <div class="right">
                        <a href="#" data-popover=".popover-dateRange" class="link open-dateRange">
                            <span>筛选</span>
                            <img src="/public/wap/images/selectDown.png">
                        </a>
                    </div> -->
                    <div class="subnavbar">
                        <div class="subnavbar-box">
                            <div class="subnavbar-wrap">
                                <div class="subnavbar-cont">
                                    <a class="subnavbar-item" id="tab_" data_status=''>全部</a>
                                    <a class="subnavbar-item" id="tab_0" data_status='0'>待提交</a>
                                    <a class="subnavbar-item" id="tab_3" data_status='3'>审核中</a>
                                    <a class="subnavbar-item" id="tab_1" data_status='1'>已放款</a>
                                    <a class="subnavbar-item" id="tab_2" data_status='2'>已退回</a>
                                    <a class="subnavbar-item" id="tab_5" data_status='5'>资料补充</a>
                                </div>
                            </div>
                        </div>
                    </div>
	            </div>
	        </div>
            <div class="pages navbar-through">
                <div class="page">
                    <div class="page-content infinite-scroll pull-to-refresh-content">
	                    <div class="pull-to-refresh-layer">
						    <div class="preloader"></div>
						    <div class="pull-to-refresh-arrow"></div>
						</div>
						<div id="orderTabs" class="tabs">
						    <div class="tab active">
								<ul class="orderList">
								</ul>
							</div>
						</div>
                    </div>
                    <div class="infinite-scroll-preloader">
						<div class="preloader"></div>
					</div>
                </div>
            </div>
        </div>
    </div>
    <!-- dateRange popover -->
    <div class="popover popover-dateRange">
        <div class="popover-angle"></div>
        <div class="popover-inner">
            <div class="list-block">
                <ul>
                    <li data="0"><a href="#" class="list-button">全部</a></li>
                    <li data="1"><a href="#" class="list-button">今天</a></li>
                    <li data="2"><a href="#" class="list-button">7天</a></li>
                    <li data="3"><a href="#" class="list-button">一个月</a></li>
                </ul>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="/public/wap/js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="/public/wap/js/framework7.min.js"></script>
    <script type="text/javascript" src="/public/wap/js/my-app.js"></script>
    <script type="text/javascript" src="/public/wap/js/order.js"></script>
    <script type="text/javascript">
    	var dataRange = '0';
        // 点击弹出日期范围弹窗
        $('.open-dateRange').on('click', function () {
            var clickedLink = this;
            myApp.popover('.popover-dateRange', clickedLink);
        });
        // 点击选择日期范围
        $('.popover-dateRange').on('click','li',function () {
            var clickedLink = $(this).text();
            dataRange = $(this).attr('data');
            $('.open-dateRange span').text(clickedLink);
            myApp.closeModal('.popover-dateRange', clickedLink);
        });


    </script>
	<script>
		var orderStatusImg = {
			'0':'orderPending.png',
			'1':'orderLoaned.png',
			'2':'orderRefused.png',
			'3':'orderExaming.png',
			'4':'orderExaming.png',
			'5':'orderSupplying.png',
			'9':'record.png'};
	  	var loading = false;  // 加载flag
		var current_page = 1;
		var status = getUrlParam('status');
		// var orderType = getUrlParam("type");
		if(status == 'null')
			{
				status = '';
			}

		function tpl(data){
			var html = '';
			if(typeof(data) =='object'){
			for(var index = 0; index < data.length; index++){
				var orderStatus = data[index].status;
				if(orderStatus < 0 || orderStatus > 5){
					orderStatus = 9;
				}
			  	html += '<li class="order-list" data="' + data[index].id + '">'
							+'<div class="order-list-info">'
								+'<div class="order-sn">' + data[index].sn + '</div>'
									+'<div class="order-type right">' + g_orderType[data[index].type] + '</div>'
							+'</div>'
							+'<div class="order-list-item">'
								+'<div class="order-customer">'
									+'<div class="order-customer-name">' + data[index].name + '</div>'
									+'<div class="order-customer-mobile">' + data[index].mobile + '</div>'
								+'</div>'
								+'<div class="order-status right" data="' + data[index].status + '">'
									+'<img src="/public/wap/images/'+orderStatusImg[orderStatus]+'">'
								+'</div>'
							+'</div>'
						+'</li>';
				}
			}
			return html;
		};

		function getOrderList(pageid,status){
			ajax_jquery({
				type: 'post',
				url: apiUrl + '/api/order/getList',
				data:{
					'page': pageid,
					'status': status,
					// 'type': orderType
				},
				success: function (resp){
					var liHtml = '';
					loading = false;
					if(resp.code == 1){
						if(resp.data.total == 0){
							liHtml = '<div class="no-result">'
										+ '<img src="/public/wap/images/record.png"/><p>暂无订单记录</p>'
									+ '</div>';
						}else if(resp.data.data.length != 0){
							current_page++;
							liHtml = tpl(resp.data.data);
						};
						$("ul.orderList").append(liHtml).height(function(n,c){return c+10;});
						if(resp.data.total <= (resp.data.per_page * resp.data.current_page)){
						    myApp.detachInfiniteScroll($$('.infinite-scroll')); // 加载完毕，则注销无限加载事件，以防不必要的加载
							// $$('.infinite-scroll-preloader').remove(); // 删除加载提示符
						};
					}else{
						if(typeof(resp.msg) == 'string') {
							ui_alert(resp.msg);
						}
					}
				}
			});
		}
		// 注册'infinite'事件处理函数
		$$('.infinite-scroll').on('infinite', function () {
			if (loading) return;	// 如果正在加载，则退出
			loading = true;			// 设置flag
			getOrderList(current_page,status);
		});

		//分类切换事件
		$('div.subnavbar').on('click','a',function(){
			$(this).addClass('tab_active')
				.siblings('a').removeClass('tab_active');
			current_page = 1
			status = $(this).attr('data_status');
			$("ul.orderList").empty();
			getOrderList(current_page,status);
			myApp.attachInfiniteScroll($$('.infinite-scroll'));
		});

		//注册‘pull-to-refresh’事件处理函数
		$$('.pull-to-refresh-content').on('refresh',function(){
			if (loading) return;
			loading = true;
			current_page = 1;
			$("ul.orderList").empty();
			getOrderList(current_page,status);
			myApp.attachInfiniteScroll($$('.infinite-scroll'));
			myApp.pullToRefreshDone($$('.pull-to-refresh-content'));
		});


		$(function(){
			$('#tab_').addClass('tab_active');
			$('#tab_' + status).click();
			//getOrderList(current_page,status);
			$(".orderList").on("click", "li", function(){
				var id = $(this).attr('data');
				var status = $(this).find('.order-status').attr('data')
				if(status == '0'){
					goToUrl(wechatStaticPath + '/order/orderSupplement.html?id=' + id);
				}else{
					goToUrl(wechatStaticPath + '/order/viewOrder.html?id=' + id);
				}
			});
			// $(".navbar").on("touchmove",function(ev){
			// 	ev.preventDefault();
			// })
		});
	</script>
</body>
</html>