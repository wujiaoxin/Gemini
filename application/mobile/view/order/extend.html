<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <meta http-equiv="pragma" content="no-cache">
    <title>VP贷-享全款的汽车分期</title>
    <link href="/public/wap/images/logo-ico.png" type="image/x-icon" rel="shortcut icon">
    <link rel="stylesheet" href="/public/wap/css/framework7.ios.css">
    <link rel="stylesheet" href="/public/wap/css/framework7.ios.colors.min.css">
    <link rel="stylesheet" type="text/css" href="/public/wap/css/my-app.css" media="all">
	<link rel="stylesheet" type="text/css" href="/public/plugs/webuploader/webuploader.css">
	<script type="text/javascript">
		var BASE_URL = ""; //根目录地址
		var order_id = {$info['id']|default=0};
		var picList = {
			'extend_pic_1':{'val':0},
			'extend_pic_2':{'val':0},
			'extend_pic_3':{'val':0},
			'extend_pic_4':{'val':0},
			'extend_pic_5':{'val':0}
		};
		{php}
			for($index = 1; $index <=5; $index++){
				if(isset($info['extend_pic_'.$index]) && $info['extend_pic_'.$index]!=0){
					$temp = get_order_files($info['extend_pic_'.$index]);
					echo '			picList.extend_pic_'.$index.'.val='.$info['extend_pic_'.$index].';';
					echo "\n";
					echo '			picList.extend_pic_'.$index.'.url="'.$temp["path"].'";';
					echo "\n";
					echo '			picList.extend_pic_'.$index.'.time="'.date('Y-m-d H:i',$temp['create_time']).'";';
					echo "\n";
				}
			}
		{/php}
    </script>
	<style type="text/css">
        .main-box-title{
            text-align: center;
            margin: 12px auto;
        }
        .form-group{
            margin-bottom:10px;
        }
        .picker-box{
            margin: 0 auto;
            padding-top: 16px;
            padding-bottom: 16px;
            width: 90%;
            background: #f5f8ff;
        }
        .imgSample{
            margin: auto auto;
            width: 70%;
            background: url('/public/wap/images/sampleImgBg.jpg');
        }
        .imgSample img{
            width: 88%;
            margin: 5% 6% 3%;
            min-height: 110px;
        }
        .picker_button{
            width:90%;
            margin: 0 auto;
        }
        .webuploader-pick {
            color: #f2f2f2;
            width: 90%;
            margin-top:5px;
            background: #005eff;
            font-size: 20px;
        }
        .filebox.image img{
            width: 100%;
        }
        .upload-file-list-info{
            width: 90%;
            margin: 0 auto;
        }   
        .form-group .control-label{
            margin-left: 5%;
            font-size: 14px;
        }
        .form-group input{
            margin-left: 5%;
            width: 86%;
            color: black;
            height: 30px;
            font-size: 14px;
            font-family: inherit;
            border-width: 1px;
            padding-left: 10px;
        }
        .optional-box{
            border: 1px dashed green;
        }
	</style>
</head>
<body>   
    <div class="views">
        <div class="view view-main">
            <div class="navbar wb">
                <div class="navbar-inner">
                    <div class="left">
                        <a href="javascript:history.go(-1)" class="link icon-only back">
                            <i class="icon icon-back"></i>
                        </a>
                    </div>
                    <div class="center blue-color">垫资申请</div>
                </div>
            </div>
            <div class="pages navbar-through">
                <div data-page="dqassess" class="page">						
				<div class="page-content main-box clearfix bg-white">
                    <div class="main-box-title">
                        <h4 class="color-black">请如实提交相关购车资料</h4>
                    </div>
                    <div class="main-box-body clearfix">
                        <form method="post" class="form form-horizontal">
                            <input type="hidden" name="id" value="0"/>
                            <input type="hidden" name="bank_uid" value="3"/>
                            <div class="form-group">
                                <div class="col-100 form-group-content">
                                    <div class="picker-box">
                                        <label class="control-label">贷款金额</label>
                                        <input type="number" name="loan_amounts" id="loan_amounts" value="{$info['loan_amounts']|default=''}"/>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-100 form-group-content">
                                    <div class="picker-box" id="box_extend_pic_3">
                                        <label class="control-label">银行放款通知单</label>
										<div id="fileList_lending_notice_pic_sample" class="imgSample">
                                            <img src="/public/wap/images/lending_notice.png">
                                        </div>
                                        <input type="hidden" name="lending_notice" id="field_lending_notice_pic" value="">
                                        <div id="fileList_lending_notice_pic" class="upload-file-list-info">
                                            <li class="affix-list-item" id="WU_FILE_101">
                                                <div class="upload-file-info">
                                                    <span class="webuploader-pick-file-close" data-queued-id="WU_FILE_101" data-id="" data-fileurl=""><i class="close"></i></span>
                                                    <span class="fname"></span>
                                                    <span class="fsize"></span>
                                                    <div class="clearfix"></div>
                                                </div>
                                                <div class="filebox image">
                                                    <img src="" class="img-responsive">
                                                </div>
                                            </li>
                                        </div>                                        
                                        <div id="picker_lending_notice_pic" class="picker_button">   
                                            <span>上传银行放款通知单照片</span>                                    
                                        </div>
									</div>
                                </div>  
                            </div>
                            <div class="form-group">
                                <div class="col-100 form-group-content">
                                    <div class="picker-box" id="box_extend_pic_4">
                                        <label class="control-label">车辆合格证</label>
                                        <div id="fileList_vehicle_QC_pic_sample" class="imgSample">
                                            <img src="/public/wap/images/vqc_pic.jpg">
                                        </div>
                                        <input type="hidden" name="vehicle_QC" id="field_vehicle_QC_pic" value="">
                                        <div id="fileList_vehicle_QC_pic" class="upload-file-list-info">
                                            <li class="affix-list-item" id="WU_FILE_102">
                                                <div class="upload-file-info">
                                                    <span class="webuploader-pick-file-close" data-queued-id="WU_FILE_102" data-id="" data-fileurl=""><i class="close"></i></span>
                                                    <span class="fname"></span>
                                                    <span class="fsize"></span>
                                                    <div class="clearfix"></div>
                                                </div>
                                                <div class="filebox image">
                                                    <img src="" class="img-responsive">
                                                </div>
                                            </li>
                                        </div>
                                        <div id="picker_vehicle_QC_pic" class="picker_button">   
                                            <span>上传车辆合格证照片</span>                                    
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-100 form-group-content">
                                    <div class="picker-box" id="box_extend_pic_2">
                                    <label class="control-label">购车发票</label>
                                        <div id="fileList_invoice_pic_sample" class="imgSample">
                                            <img src="/public/wap/images/invoice.jpg">
                                        </div>
                                        <input type="hidden" name="invoice_pic" id="field_invoice_pic" value="">
                                        <div id="fileList_invoice_pic" class="upload-file-list-info">
                                            <li class="affix-list-item" id="WU_FILE_103">
                                                <div class="upload-file-info">
                                                    <span class="webuploader-pick-file-close" data-queued-id="WU_FILE_103" data-id="" data-fileurl=""><i class="close"></i></span>
                                                    <span class="fname"></span>
                                                    <span class="fsize"></span>
                                                    <div class="clearfix"></div>
                                                </div>
                                                <div class="filebox image">
                                                    <img src="" class="img-responsive">
                                                </div>
                                            </li>
                                        </div>
                                         <div id="picker_invoice_pic" class="picker_button">
                                            <span>上传购车发票照片</span>   
                                         </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-100 form-group-content">
                                    <div class="picker-box" id="box_extend_pic_1">
                                        <label class="control-label">首付凭证</label>
                                        <div id="fileList_down_payment_pic_sample" class="imgSample">
                                            <img src="/public/wap/images/down_payment.jpg">
                                        </div>
                                        <input type="hidden" name="down_payment_pic" id="field_down_payment_pic" value="">
                                        <div id="fileList_down_payment_pic" class="upload-file-list-info">
                                            <li class="affix-list-item" id="WU_FILE_104">
                                                <div class="upload-file-info">
                                                    <span class="webuploader-pick-file-close" data-queued-id="WU_FILE_104" data-id="" data-fileurl=""><i class="close"></i></span>
                                                    <span class="fname"></span>
                                                    <span class="fsize"></span>
                                                    <div class="clearfix"></div>
                                                </div>
                                                <div class="filebox image">
                                                    <img src="" class="img-responsive">
                                                </div>
                                            </li>
                                        </div>
                                        <div id="picker_down_payment_pic" class="picker_button">
                                            <span>上传首付凭证照片</span>   
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-100 form-group-content">
                                    <div class="picker-box" id="box_extend_pic_5">
                                        <label class="control-label">车辆保单</label>
                                        <div id="fileList_car_insurance_pic_sample" class="imgSample">
                                            <img src="/public/wap/images/car_insurance.jpg">
                                        </div>
                                        <input type="hidden" name="car_insurance_pic" id="field_car_insurance_pic" value="">
                                        <div id="fileList_car_insurance_pic" class="upload-file-list-info">
                                            <li class="affix-list-item" id="WU_FILE_105">
                                                <div class="upload-file-info">
                                                    <span class="webuploader-pick-file-close" data-queued-id="WU_FILE_105" data-id="" data-fileurl=""><i class="close"></i></span>
                                                    <span class="fname"></span>
                                                    <span class="fsize"></span>
                                                    <div class="clearfix"></div>
                                                </div>
                                                <div class="filebox image">
                                                    <img src="" class="img-responsive">
                                                </div>
                                            </li>
                                        </div>
                                        <div id="picker_car_insurance_pic" class="picker_button">
                                            <span>上传车辆保单照片</span>   
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group" >
                                <div class="col-100 form-group-content">
                                    <p class="control-label color-blue">可选内容，请尽量填写</p>
                                    <div class="picker-box optional-box">
                                        <label class="control-label">购车日期</label>
                                        <input type="text" name="purchase_date" id="purchase_date" value="{$info['purchase_time'|date='Y-m-d',###]}"/>
                                        <label class="control-label">购车金额</label>
                                        <input type="number" name="purchase_amount" id="purchase_amount" value="{$info['purchase_amount']|default=0}"/>
                                        <label class="control-label">汽车品牌</label>
                                        <input type="text" name="car_brand" id="car_brand" value="{$info['car_brand']}"/>
                                        <label class="control-label">车型</label>
                                        <input type="text" name="car_model" id="car_model" value="{$info['car_model']}"/>
                                        <label class="control-label">车辆颜色</label>
                                        <input type="text" name="car_color" id="car_color" value="{$info['car_color']}"/>
                                        <label class="control-label">车架号</label>
                                        <input type="text" name="car_VIN" id="car_VIN" value="{$info['car_VIN']}"/>
                                        <label class="control-label">保险公司</label>
                                        <input type="text" name="insurance_comp" id="insurance_comp" value="{$info['insurance_comp']}"/>
                                        <label class="control-label">保单号</label>
                                        <input type="text" name="insurance_id" id="insurance_id"  value="{$info['insurance_id']}"/>
                                    </div>
								 </div>
							</div>
                            <div class="content-block">
                                <a class="button button-big button-raised butcom-css dpblue" id="submit">一键垫资</a>
                            </div>
                        </form>
                    </div>
                </div>
				</div>
            </div>
        </div>
    </div>
  	<div id="dialog" class="dialog">
        <div id="dialogContent">
            <div id="dialogMain"></div>
        </div>
    </div>
    <div id="loading"></div>
	<script type="text/javascript" src="/public/wap/js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="/public/wap/js/framework7.min.js"></script>
    <script type="text/javascript" src="/public/wap/js/my-app.js"></script>
	<script type="text/javascript" src="/public/plugs/webuploader/webuploader.min.js"></script>
	<script type="text/javascript" src="/public/wap/js/webuploader.custom.js"></script>
	<script type="text/javascript">
	var calendarDefault = myApp.calendar({
		input: '#purchase_date',
	});
	
	function dateToUnixTime(str){
		//var str ="2013-01-01 00:00:00";
		str = str +' 00:00:00';
		str = str.replace(/-/g,"/");
		var date = new Date(str); 
		var humanDate = new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate(),date.getHours(),date.getMinutes(), date.getSeconds())); 
		return humanDate.getTime()/1000 - 8*60*60;
	}

    for(var i = 1;i <= 5 ; i++){
                var picObj = eval('picList.extend_pic_' + i);
                if(picObj.val){
                    $('#box_extend_pic_'+i).children('.imgSample').hide();
                    $('#box_extend_pic_'+i).children('input').val(picObj.val);
                    $('#box_extend_pic_'+i).find('span.webuploader-pick-file-close').attr(
                        {'data-fileurl':picObj.url,'data-id':picObj.val});
                    $('#box_extend_pic_'+i).find('span.fsize').html('上传时间:'+picObj.time)
                    $('#box_extend_pic_'+i).find('.filebox').children('img').attr('src',picObj.url);
                }else {
                    $('#box_extend_pic_'+i).find('.imgSample').show();
                    $('#box_extend_pic_'+i).find('.upload-file-list-info > li').remove();
                }
    }

		var uploadsize =  20;	
        function btnSentUploader(picName){
            $("#picker_" + picName + "_pic").SentUploader({
                fileNumLimit:1,
                uploadEvents: {
                    uploadComplete:function(file){
                        if(file.type.substring(0,6) == "image/"){
                            $("#fileList_" + picName + "_pic_sample").hide();
                        }
                    }
                },
                listName : 'fileList_' + picName + '_pic',
                hiddenName: 'field_' + picName + '_pic',
                hiddenValType:1,
                fileSingleSizeLimit:uploadsize*1024*1024,
                closeX:true,
                compress:{
                    width: 1024,
                    // height: 1600,

                    // 图片质量，只有type为`image/jpeg`的时候才有效。
                    quality: 90,

                    // 是否允许放大，如果想要生成小图的时候不失真，此选项应该设置为false.
                    allowMagnify: false,

                    // 是否允许裁剪。
                    crop: false,

                    // 是否保留头部meta信息。
                    preserveHeaders: true,

                    // 如果发现压缩后文件大小比原来还大，则使用原来图片
                    // 此属性可能会影响图片自动纠正功能
                    noCompressIfLarger: false,

                    // 单位字节，如果图片大小小于此值，不会采用压缩。
                    compressSize: 0
                }
            },
            {
                fileType: 'service',
                filename : 'images',
            });
        };	
		$(function(){
            btnSentUploader('lending_notice');
            btnSentUploader('vehicle_QC');
            btnSentUploader('invoice');
            btnSentUploader('down_payment');
            btnSentUploader('car_insurance');
			$("#submit").click(function(){
                var loan_amounts = $('#loan_amounts').val();
                if(loan_amounts == ''){
                    ui_alert('请填写垫资金额');
                    return;
                }else if(loan_amounts < 1000 || loan_amounts > 500000){
                    ui_alert('请确认垫资金额');
                    return;
                };
                var $checkValid = $('.form-group .imgSample+input');
                for(var index =0 ;index < 5; index++){
                    if($checkValid[index].value == ''){
                        ui_alert('请'+$checkValid.siblings('div.picker_button').find('span')[index].innerHTML);
                        return;
                    }
                };

                var field_lending_notice_pic_id = $('#field_lending_notice_pic').val();         
                var field_vehicle_QC_pic_id = $('#field_vehicle_QC_pic').val();         
                var field_invoice_pic_id =$('#field_invoice_pic').val();             
                var field_down_payment_pic_id =$('#field_down_payment_pic').val();             
                var field_car_insurance_pic_id =$('#field_car_insurance_pic').val();         
                var id = order_id; //$('input[name="id"]').val();
                var car_brand = $('#car_brand').val();
                var car_model = $('#car_model').val();
                var car_color = $('#car_color').val();
                var car_VIN = $('#car_VIN').val();
                var insurance_comp = $('#insurance_comp').val();
                var insurance_id = $('#insurance_id').val();
                var purchase_time = dateToUnixTime($('#purchase_date').val());
				var purchase_amount = $('#purchase_amount').val();

                 ajax_jquery({
                    type: 'post', // 提交方式 post
                    url: '/mobile/order/extend', // 需要提交的 url
                    datatype:'json',
                    data: {
                        'id': id,
                        'car_brand': car_brand,
                        'car_model': car_model,
                        'car_color': car_color,
                        'car_VIN': car_VIN,
                        'insurance_comp': insurance_comp,
                        'insurance_id': insurance_id,
                        'loan_amounts': loan_amounts,
                        'purchase_time': purchase_time,
                        'purchase_amount': purchase_amount,
                        'extend_pic_1': field_down_payment_pic_id,
                        'extend_pic_2': field_invoice_pic_id,
                        'extend_pic_3': field_lending_notice_pic_id,
                        'extend_pic_4': field_vehicle_QC_pic_id,
                        'extend_pic_5': field_car_insurance_pic_id                      
                    },
                    success: function(data) { // data 保存提交后返回的数据，一般为 json 数据
                        if(data.code == 1){
                            ui_alert("垫资申请成功!", function () {
                                 window.location.href = '/mobile' ;            
                             });
                        }else{
                            if (typeof(data.msg) == 'string') {
                                ui_alert(data.msg);
                            }  
                        }
                    }
                }); 
            });
		});
	</script>  

</body>
</html>